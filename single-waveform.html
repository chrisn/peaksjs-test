<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>waveform-data test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://unpkg.com/waveform-data@2.0.1/dist/waveform-data.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        body {
            padding: 40px;
        }
        canvas {
            border: 1px solid grey;
        }
        #slider-range {
            margin-top: 20px;
            width: 600px;
        }
    </style>
</head>
<body>

    <canvas id="canvas" width="600" height="300"></canvas>

    <div>
        <input type="text" id="start" value="0" placeholder="start">
        <input type="text" id="end" placeholder="end">
        <button id="reset" disabled>Reset</button>
        <div id="slider-range"></div>
    </div>

    <script>

        let ctx, waveform, startInput, endInput;

        function normalise(num, min, max) {
            return (num - min) / (max - min);
        }

        // function scaleX(x) {
        //     var n = normalise(x, 0, length);
        //     n = n * canvas.width;
        //     return n;
        // }

        function scaleY(amplitude, height) {
            var range = 64;
            var offset = 64;

            return height - ((amplitude + offset) * height) / range;
        }

        function getRndColor() {
            var r = 255*Math.random()|0,
                g = 255*Math.random()|0,
                b = 255*Math.random()|0;
            return 'rgb(' + r + ',' + g + ',' + b + ')';
        }

        function drawWaveform(waveform) {
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            var adapter = waveform.adapter;
            var x, val;

            var barspacing = 4;
            var barwidth = 2;

            var increment = Math.floor((waveform.offset_length / canvas.width) * barspacing);

            for (x = Math.floor(waveform.offset_start); x < Math.floor(waveform.offset_end); x += increment) {
                val = adapter.at(x);
                var height = Math.max(barwidth, Math.abs(scaleY(val, canvas.height)));
                var norm = normalise(x, waveform.offset_start, waveform.offset_end);
                var xpos = Math.floor(canvas.width * norm) + barwidth;
                var ypos = (canvas.height / 2) - (height / 2);
                ctx.fillRect(xpos, ypos, barwidth, height);
            }
            
        }

        document.addEventListener("DOMContentLoaded", function(event) {
            
            const canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            startInput = document.querySelector('#start');
            endInput = document.querySelector('#end');

            var resetButton = document.querySelector('#reset');

            resetButton.addEventListener('click', () => {
                draw();
            });

            const xhr = new XMLHttpRequest();

            // .dat file generated by audiowaveform program
            xhr.responseType = 'arraybuffer';
            xhr.open("GET", 'vdc_100052359795.0x000018.dat');

            xhr.addEventListener('load', (progressEvent) => {

                const data = new Int16Array(progressEvent.target.response);
                //console.log(data.length);

                waveform = WaveformData.create(data.buffer);

                draw();

                resetButton.removeAttribute('disabled');
            });

            xhr.send();

        });

        function draw() {

            // console.log(waveform.offset_duration);    // -> 10.33333333333

            // fitting the data in canvas width
            //waveform = waveform.resample({ width: canvas.width });

            var start = Number(startInput.value) || 0;
            var end = Number(endInput.value) || waveform.duration;

            startInput.value = start;
            endInput.value = end;

            $('#slider-range').slider({
                max: waveform.duration,
                values: [start, end]
            });

            var offsetStart = start * waveform.pixels_per_second; // start at 10 secs
            var offsetEnd = end * waveform.pixels_per_second;

            waveform.offset(offsetStart, offsetEnd);

            drawWaveform(waveform);
        }

        $(function() {
            $("#slider-range").slider({
                range: true,
                min: 0,
                slide: function(event, ui) {
                    $("#start").val($("#slider-range").slider("values", 0));
                    $("#end").val($("#slider-range").slider("values", 1));
                }
            });
        });
        
    </script>
</body>
</html>